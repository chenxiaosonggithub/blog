From ad254b9a1758f1a7ac057f4bd4c01c3c60c8ac7d Mon Sep 17 00:00:00 2001
From: ChenXiaoSong <chenxiaosong@chenxiaosong.com>
Date: Wed, 25 Feb 2026 05:30:01 +0000
Subject: [PATCH] debug create_posix_rsp

Signed-off-by: ChenXiaoSong <chenxiaosong@chenxiaosong.com>
---
 fs/smb/client/smb2pdu.c | 10 ++++++++--
 fs/smb/server/smbacl.c  |  2 ++
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.c
index c7004b4eb87c..c67c67fbfb72 100644
--- a/fs/smb/client/smb2pdu.c
+++ b/fs/smb/client/smb2pdu.c
@@ -2371,6 +2371,7 @@ parse_posix_ctxt(struct create_context *cc, struct smb2_file_all_info *info,
 		cifs_dbg(VFS, "bad owner sid in posix create response\n");
 		return;
 	}
+	printk("%s:%d, owner sid len:%d\n", __func__, __LINE__, sid_len);
 	memcpy(&posix->owner, sid, sid_len);
 
 	sid = sid + sid_len;
@@ -2379,6 +2380,7 @@ parse_posix_ctxt(struct create_context *cc, struct smb2_file_all_info *info,
 		cifs_dbg(VFS, "bad group sid in posix create response\n");
 		return;
 	}
+	printk("%s:%d, group sid len:%d\n", __func__, __LINE__, sid_len);
 	memcpy(&posix->group, sid, sid_len);
 
 	cifs_dbg(FYI, "nlink=%d mode=%o reparse_tag=%x\n",
@@ -2439,8 +2441,11 @@ int smb2_parse_contexts(struct TCP_Server_Info *server,
 			}
 			break;
 		case 16:
-			if (posix && !memcmp(name, smb3_create_tag_posix, 16))
-				parse_posix_ctxt(cc, buf, posix);
+			// if (posix && !memcmp(name, smb3_create_tag_posix, 16))
+			// The posix pointer is always NULL, so use test_posix to debug
+			struct create_posix_rsp test_posix;
+			if (!memcmp(name, smb3_create_tag_posix, 16))
+				parse_posix_ctxt(cc, buf, &test_posix);
 			break;
 		default:
 			cifs_dbg(FYI, "%s: unhandled context (nlen=%zu dlen=%zu)\n",
@@ -5381,6 +5386,7 @@ int posix_info_sid_size(const void *beg, const void *end)
 	if (subauth < 1 || subauth > 15)
 		return -1;
 
+	printk("%s:%d, num_subauth:%zu\n", __func__, __LINE__, subauth);
 	total = 1 + 1 + 6 + 4*subauth;
 	if (beg + total > end)
 		return -1;
diff --git a/fs/smb/server/smbacl.c b/fs/smb/server/smbacl.c
index 49c2abb29bf5..bb8d6427d991 100644
--- a/fs/smb/server/smbacl.c
+++ b/fs/smb/server/smbacl.c
@@ -252,6 +252,8 @@ void id_to_sid(unsigned int cid, uint sidtype, struct smb_sid *ssid)
 	/* RID */
 	ssid->sub_auth[ssid->num_subauth] = cpu_to_le32(cid);
 	ssid->num_subauth++;
+	printk("%s:%d, sidtype:%d, num_subauth:%d\n", __func__, __LINE__,
+	       sidtype, ssid->num_subauth);
 }
 
 static int sid_to_id(struct mnt_idmap *idmap,
-- 
2.53.0

