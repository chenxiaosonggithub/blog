From 6a03e8cc987d2661712dd474de74a341e0205f7f Mon Sep 17 00:00:00 2001
From: ChenXiaoSong <chenxiaosong@kylinos.cn>
Date: Thu, 4 Dec 2025 10:47:36 +0800
Subject: [PATCH] smb: stat smb2maperror comparison count

Signed-off-by: ChenXiaoSong <chenxiaosong@kylinos.cn>
---
 fs/smb/common/smb2maperror.c | 23 ++++++-----------------
 1 file changed, 6 insertions(+), 17 deletions(-)

diff --git a/fs/smb/common/smb2maperror.c b/fs/smb/common/smb2maperror.c
index c4109fc6320f..8e797b420e17 100644
--- a/fs/smb/common/smb2maperror.c
+++ b/fs/smb/common/smb2maperror.c
@@ -13,6 +13,7 @@
 #include "common.h"
 #include "smb2status.h"
 
+static int cmp_count = 0;
 static struct status_to_posix_error smb2_error_map_table[] = {
 	{STATUS_WAIT_1, -EIO, "STATUS_WAIT_1"},
 	{STATUS_WAIT_2, -EIO, "STATUS_WAIT_2"},
@@ -2416,6 +2417,7 @@ static int cmp_smb2_status(const void *_a, const void *_b)
 {
 	const struct status_to_posix_error *a = _a, *b = _b;
 
+	cmp_count++;
 	if (a->smb2_status < b->smb2_status)
 		return -1;
 	if (a->smb2_status > b->smb2_status)
@@ -2440,10 +2442,12 @@ EXPORT_SYMBOL_GPL(smb2_get_err_map);
 
 void smb2_init_maperror(void)
 {
+	cmp_count = 0;
 	/* Sort in ascending order */
 	sort(smb2_error_map_table, err_map_num,
 	     sizeof(struct status_to_posix_error),
 	     cmp_smb2_status, NULL);
+	printk("%s, cmp_count:%d\n", __func__, cmp_count);
 }
 
 #if IS_ENABLED(CONFIG_SMB_KUNIT_TEST)
@@ -2482,27 +2486,12 @@ static void maperror_test_get_err_map(struct kunit *test)
 {
 	struct status_to_posix_error expect;
 
-	/* first element */
-	expect = smb2_error_map_table[0];
-	get_and_cmp_err_map(test, &expect);
-
 	/* last element */
+	cmp_count = 0;
 	expect = smb2_error_map_table[err_map_num - 1];
 	get_and_cmp_err_map(test, &expect);
+	printk("%s, cmp_count:%d\n", __func__, cmp_count);
 
-	expect = (struct status_to_posix_error) {
-		.smb2_status = STATUS_SERIAL_COUNTER_TIMEOUT,
-		.posix_error = -ETIMEDOUT,
-		.status_string = "STATUS_SERIAL_COUNTER_TIMEOUT",
-	};
-	get_and_cmp_err_map(test, &expect);
-
-	expect = (struct status_to_posix_error) {
-		.smb2_status = STATUS_IO_REPARSE_TAG_NOT_HANDLED,
-		.posix_error = -EOPNOTSUPP,
-		.status_string = "STATUS_REPARSE_NOT_HANDLED",
-	};
-	get_and_cmp_err_map(test, &expect);
 }
 
 /*
-- 
2.43.0

