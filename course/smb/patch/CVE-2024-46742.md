[CVE-2024-46742](https://nvd.nist.gov/vuln/detail/CVE-2024-46742)的修复补丁: [`4e8771a3666c8 smb/server: fix potential null-ptr-deref of lease_ctx_info in smb2_open()`](https://lore.kernel.org/all/20240822082101.391272-3-chenxiaosong@chenxiaosong.com/)

# 问题描述

smb server的`smb2_open()`函数超过900行，是内核代码中比较长的函数之一，函数太长会让代码的维护变得困难，`smb2_open()`函数已经出现过很多问题，如引用计数泄露、空指针解引用、返回值错误等，[CVE-2024-46742](https://nvd.nist.gov/vuln/detail/CVE-2024-46742)便是其中之一。

# 复现

[libsmb2仓库](https://git.samba.org/?p=libsmb2.git;a=tree)（[也可以访问github上的仓库](https://github.com/sahlberg/libsmb2)）。
