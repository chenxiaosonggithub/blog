既然在深入nfs的知识，那就干脆把smb相关的知识一起对比着学习一下，本文翻译自[6/25/2021, [MS-SMB]: Server Message Block (SMB) Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb)，大部分借助于ChatGPT翻译，仅作为我个人的参考，如果你想查阅，建议看英文文档，因为我不确定我记录的中文翻译是否完整和正确。

持续更新中。。。

# 1. 介绍

服务器消息块（SMB）版本1.0协议定义了对通用互联网文件系统（CIFS）协议的扩展，该协议在[MS-CIFS]中进行了规定。除非在本文档中有明确扩展或覆盖，否则所有在[MS-CIFS]中为Windows NT操作系统客户端和服务器描述的规范和行为都适用于本文档中涉及的Windows客户端和服务器实现。本文档中涉及的Windows客户端和服务器实现的列表在第6节中提供。

除非另有说明，本文档仅提供相对于[MS-CIFS]规范的CIFS协议的扩展。扩展后的CIFS协议称为服务器消息块（SMB）版本1.0协议。要创建服务器消息块（SMB）版本1.0协议的完整实现，需要同时使用本文档和[MS-CIFS]。

本文档还定义了Windows相对于SMB扩展规范中描述的可选行为的行为。

本规范的第1.5、1.8、1.9、2和3节是规范性的。本规范中的所有其他部分和示例都是信息性的。

## 1.1. 术语表

本文档使用以下术语：

@GMT 令牌：一个特殊的令牌，可以作为文件路径的一部分存在，用于指示查看文件或目录的先前版本的请求。格式为"@GMT-YYYY.MM.DD-HH.MM.SS"。这个16位的Unicode字符串表示协调世界时（UTC）的时间和日期，其中YYYY表示年，MM表示月，DD表示日，HH表示小时，MM表示分钟，SS表示秒。

8.3 名称：文件名字符串的长度限制为12个字符，包括最多八个字符的基本名称，一个字符的句点，以及最多三个字符的文件名扩展名。有关8.3文件名的更多信息，请参见[MS-CIFS]第2.2.1.1.1节。

字节模式：命名管道的两种模式之一，另一种是消息模式。在字节模式中，在命名管道上发送或接收的数据没有消息边界，而是被视为连续的流。[XOPEN-SMB]使用术语流模式代替字节模式，而[SMB-LM1X]将字节模式称为字节流模式。

通用互联网文件系统（CIFS）：Server Message Block（SMB）协议的“NT LM 0.12” / NT LAN Manager方言，如在Windows NT中实施。 CIFS名称起源于上世纪90年代，作为试图基于当时的Windows NT实现创建SMB的Internet标准的一部分。

协调世界时（UTC）：一种高精度的原子时间标准，大致跟踪世界时（UT）。它是地球上所有法定、民用时间的基础。世界各地的时区表示为相对于UTC的正负偏移。在这个角色中，它也被称为Zulu时间（Z）和格林威治平均时间（GMT）。在这些规范中，对UTC的所有引用都是指UTC-0（或GMT）的时间。

Copychunk Resume Key：由Server Message Block（SMB）服务器在对SMB客户端的请求响应中生成的一个24字节的值，用于唯一标识SMB服务器上的一个打开的文件。 Copychunk Resume Key由SMB服务器端的数据移动操作使用，该操作在不要求客户端读取数据然后将数据写回服务器的情况下在文件之间移动数据。请注意，这与[MS-CIFS]第2.2.6.2节中指定的服务器对SMB_COM_TRANSACTION2客户端请求的TRANS2_FIND_FIRST2子命令的响应中返回的恢复键不同。

已弃用：已被协议中的新功能取代的功能。不建议使用已弃用的功能。服务器实现可能需要实现已弃用的功能，以支持协商较早的SMB方言的客户端。

自主访问控制列表（DACL）：由对象的所有者控制的访问控制列表（ACL），指定特定用户或组对对象的访问权限。

分布式文件系统（DFS）：逻辑上将位于不同服务器上的物理共享文件夹通过透明地连接它们到一个或多个分层名称空间。DFS还提供容错和负载共享功能。

域：共享共同命名空间和管理基础结构的一组用户和计算机。该集合的至少一台计算机必须充当域控制器（DC），并托管一个成员列表，该列表标识域的所有成员，以及可选地托管Active Directory服务。域控制器为其成员提供身份验证，为其成员创建一个信任单元。每个域都有一个在其成员之间共享的标识符。有关更多信息，请参见[MS-AUTHSOD]第1.1.1.5节和[MS-ADTS]。

Fid：Server Message Block（SMB）服务器用于表示已打开的文件、命名管道、打印机或设备的16位值。 Fid是SMB服务器在响应客户端打开或创建文件、命名管道、打印机或设备的请求时返回的。 SMB服务器保证在给定的SMB连接中，直到关闭SMB连接，返回的Fid值是唯一的，然后可以重新使用Fid值。 Fid由SMB客户端在后续SMB命令中用于标识已打开的文件、命名管道、打印机或设备。

文件分配表（FAT）：在使用FAT或FAT32文件系统格式化卷时操作系统创建的数据结构。操作系统在FAT中存储有关每个文件的信息，以便稍后检索文件。

文件系统控制（FSCTL）：向文件系统发出的命令，以更改或查询文件系统的行为，和/或设置或查询与特定文件或文件系统本身关联的元数据。

FileId：用于表示文件的64位值。 FileId的值在本地文件系统或远程文件服务器的单个卷上是唯一的。如果支持FileIds，那么文件系统必须保证FileId在卷内是唯一的，但不保证在卷之间是唯一的。并非所有本地文件系统都支持FileIds。在Windows上，NTFS支持FileIds，但文件分配表（FAT）文件系统不支持它们。

访客账户：对于在计算机上没有账户的用户可用的安全账户。

输入/输出控制（IOCTL）：发往目标文件系统或目标设备的命令，以便查询或更改目标的行为；或查询或更改与目标或目标本身关联的数据和属性。

信息级别：用于标识客户端请求的卷、文件或设备信息的数字。与每个信息级别相对应，服务器向客户端返回一个特定的结构，其中包含响应中的不同信息。

密钥分发中心（KDC）：实施Kerberos协议中指定的身份验证和票据授予服务的Kerberos服务。服务在由领域或域的管理员选择的计算机上运行；它不出现在网络上的每台机器上。它必须能够访问为其服务的领域的帐户数据库。 KDC集成到域控制器角色中。它是一项供客户端提供用于身份验证到服务的票据的网络服务。

小尾数：多字节值，字节顺序以最低地址的内存位置存储最低有效字节。

消息模式：命名管道可以是两种类型：字节模式或消息模式。在字节模式中，在命名管道上发送或接收的数据没有消息边界，而是被视为连续的流。在消息模式中，强制执行消息边界。

命名管道：用于管道服务器与一个或多个管道客户端之间进行通信的命名的单向或双工管道。

网络字节顺序：多字节数字在网络上传输的顺序，最重要的字节首先传输（以大端存储）。这可能与以特定处理器为目标的数字通常存储在内存中的顺序相匹配，也可能不匹配。

NT文件系统（NTFS）：一种专有的Microsoft文件系统。有关更多信息，请参见[MSFT-NTFS]。

对象存储：一种系统，它提供了代表远程客户端的本地资源创建、查询、修改或应用策略的能力。对象存储由文件系统、命名管道或作为文件访问的打印作业支持。

过时的：一个没有替代但即将过时的功能。尽管不建议使用已过时的功能，但服务器实现可能需要实现它们以支持协商较早的SMB方言的客户端。

开放（Open）：与特定文件或具体客户端到特定服务器的命名管道的当前建立的访问相对应的运行时对象，使用特定用户安全上下文。客户端和服务器都维护表示活动访问的打开。

Oplock断开（Oplock break）：由Server Message Block（SMB）服务器发送到SMB客户端的未经请求的请求，通知客户端更改文件的oplock级别。

机会锁（Opportunistic lock，Oplock）：一种机制，允许客户端以一致的方式动态更改其缓冲策略，以提高性能并减少网络使用。如果客户端可以在本地缓冲文件数据，网络文件操作的性能可能会提高，这减少或消除了发送和接收网络数据包的需要。例如，如果客户端知道没有其他进程访问数据，客户端可能不必将信息写入远程服务器上的文件。同样，如果客户端知道没有其他进程写入数据到远程文件，客户端可能会缓冲远程文件的读取前数据。有三种类型的oplocks：独占oplock允许客户端以独占方式打开文件，并允许客户端执行任意缓冲。批处理oplock允许客户端保持文件在服务器上打开，即使客户端机器上的本地访问器已关闭文件。Level II oplock表示文件有多个读者且没有写入者。如果协商的SMB方言是NT LM 0.12或更高版本，则支持Level II Oplock。当客户端打开文件时，它请求服务器在文件上授予它特定类型的oplock。服务器的响应指示授予客户端的oplock类型。客户端使用授予的oplock类型来调整其缓冲策略。

原始设备制造商（OEM）字符：在MS-DOS和Windows操作系统中使用的8位编码，用于将一系列位与特定字符相关联。 ASCII字符集将字母、数字和指定的标点符号和控制字符映射到0到127的数字。术语“代码页”用于指称ASCII字符集的扩展，将指定的字符和符号映射到128到255的数字。这些代码页被称为OEM字符集。有关更多信息，请参见[MSCHARSET]。

进程标识符（PID）：一种非零整数，由一些操作系统（例如Windows和UNIX）用于唯一标识一个进程。有关更多信息，请参见[PROCESS]。

原始读取（在命名管道上）：从命名管道读取数据的行为，即使管道被设置为消息模式管道，也会忽略消息边界。

重解析点（Reparse point）：可添加到文件的属性，用于存储对NTFS或ReFS不透明的用户定义数据集合。如果打开了具有重解析点的文件，则打开通常会失败，并显示STATUS_REPARSE，以便相关的文件系统过滤驱动程序可以检测与此重解析点关联的文件的打开。此时，每个安装的过滤驱动程序都可以检查是否是重解析点的所有者，并在是的情况下执行文件的特殊处理。此数据的格式由存储数据的应用程序和解释数据并处理文件的文件系统过滤器了解。例如，标记为文件的重解析点所有者的加密过滤器可以查找该文件的加密密钥。一个文件最多可以关联一个重解析点。有关更多信息，请参见[MS-FSCC]。

安全上下文（Security context）：包含特定安全主体的授权信息的抽象数据结构，以Token/Authorization Context（参见[MS-DTYP]第2.5.2节）的形式存在。服务器使用安全上下文中的授权信息来检查对请求资源的访问。安全上下文还包含与另一个安全主体执行安全通信所需的密钥标识符等信息。

安全描述符（Security descriptor）：包含与可安全对象关联的安全信息的数据结构。安全描述符通过其安全标识符（SID）标识对象的所有者。如果为对象配置了访问控制，其安全描述符包含一个包含被允许或拒绝访问的安全主体的自由访问控制列表（DACL）。应用程序使用此结构来设置和查询对象的安全状态。安全描述符用于保护对对象的访问，以及控制访问对象时进行哪种类型的审计。安全描述符的格式在[MS-DTYP]第2.4.6节中指定；安全描述符的字符串表示形式，称为SDDL，在[MS-DTYP]第2.5.1节中指定。

安全标识符（SID）：用于标识安全主体的标识符，用于识别帐户或组。在概念上，SID由帐户权威部分（通常是域）和表示相对于帐户权威的标识的较小整数（RID）组成。SID的格式在[MS-DTYP]第2.4.2节中指定；SID的字符串表示形式在[MS-DTYP]第2.4.2节和[MS-AZOD]第1.1.1.2节中指定。

安全主体名称（SPN）：用于标识安全主体（例如，连接到域的机器的machinename$@domainname或用户的username@domainname）的名称。通过域名系统（DNS）解析Domainname。

服务器消息块（SMB）：用于通过网络从服务器系统请求文件和打印服务的协议。SMB协议通过额外的安全、文件和磁盘管理支持扩展了CIFS协议。有关更多信息，请参见[CIFS]和[MS-SMB]。

会话（Session）：在服务器消息块（SMB）中，SMB客户端和SMB服务器之间的持久状态关联。会话与底层NetBIOS或TCP连接的生命周期相关联。

影子副本（Shadow copy）：在定义良好的瞬间制作的卷上的数据的副本。

共享（Share）：由Common Internet File System（CIFS）服务器提供的资源，供CIFS客户端通过网络访问。共享通常表示一个目录树及其包含的文件（通常称为“磁盘共享”或“文件共享”）或打印机（“打印共享”）。如果关于共享的信息保存在持久存储中（例如，Windows注册表），并在重新启动文件服务器时重新加载，则该共享称为“粘性共享”。一些共享名称保留用于特定功能，并称为特殊共享：IPC$，用于进程间通信；ADMIN$，用于远程管理；以及A$、B$、C$（和其他以美元符号结尾的本地磁盘名称），分配给本地磁盘设备。

共享连接（Share connect）：在Common Internet File System（CIFS）服务器和客户端之间建立身份验证和共享状态的行为，允许CIFS客户端访问CIFS服务器提供的共享。

SMB命令（SMB command）：为执行操作而交换的一组SMB消息。SMB命令通常由消息头中的唯一命令代码标识，尽管一些SMB命令要求使用辅助命令。在[MS-CIFS]中，术语“命令”除非另有说明，否则指的是SMB命令。

SMB连接（SMB connection）：Server Message Block（SMB）客户端和SMB服务器之间的传输连接。假定SMB连接提供可靠的按顺序传递消息的语义。SMB连接可以在SMB客户端和SMB服务器都支持的任何可用SMB传输上建立，如[MS-CIFS]中指定。

SMB方言（SMB dialect）：有几种不同版本和子版本的Server Message Block（SMB）协议。SMB协议的特定版本称为SMB方言。不同的SMB方言可以包括新的SMB消息，以及用于其他SMB方言中使用的现有SMB消息的字段和语义的更改。当SMB客户端连接到SMB服务器时，客户端和服务器将协商要使用的SMB方言。

SMB消息（SMB message）：协议数据单元。SMB消息由头部、参数部分和数据部分组成。后两者可以为零长度。SMB消息有时简称为SMB。在[MS-CIFS]中，术语“命令”除非另有说明，否则指的是SMB命令。

SMB会话（SMB session）：在SMB连接上建立的SMB客户端和SMB服务器之间的经过身份验证的用户连接。在单个SMB连接上可以有多个活动SMB会话。SMB包头中的Uid字段用于区分各个会话。

快照（Snapshot）：卷的阴影副本制作的时刻。

流（Stream）：写入到目标文件系统上文件的字节序列。存储在使用文件系统的卷上的每个文件都包含至少一个流，通常用于存储文件的主要内容。文件中的其他流可以用于存储文件属性、应用程序参数或与该文件特定信息相关的其他信息。每个文件都有一个默认数据流，默认情况下未命名。该数据流和与文件关联的任何其他数据流可以选择命名。

系统访问控制列表（SACL）：控制为尝试访问可安全对象而生成的审核消息的访问控制列表（ACL）。获取或设置对象的SACL的能力由通常仅由系统管理员持有的特权控制。

传输控制协议（TCP）：与Internet协议（IP）一起用于在Internet上在计算机之间发送数据的协议。TCP处理数据的个别单元（称为分组），这些分组是消息分解为有效路由通过Internet的形式。

树连接（Tree connect）：CIFS客户端和远程CIFS服务器之间的共享之间的连接。

Unicode：由Unicode Consortium开发的字符编码标准，表示世界上几乎所有的书写语言。Unicode标准[UNICODE5.0.0/2007]提供三种形式（UTF-8、UTF-16和UTF-32）和七种方案（UTF-8、UTF-16、UTF-16 BE、UTF-16 LE、UTF-32、UTF-32 LE和UTF-32 BE）。

Unicode字符串：Unicode 8位字符串是8位单位的有序序列，Unicode 16位字符串是16位代码单位的有序序列，Unicode 32位字符串是32位代码单位的有序序列。在某些情况下，可以接受不以终止的空字符结尾。除非另有说明，所有Unicode字符串都遵循UTF-16LE编码方案，没有字节顺序标记（BOM）。

卷标识符（VolumeId）：用于表示卷的128位值。VolumeId的值在单台计算机上是唯一的（可以是本地文件系统或远程文件服务器）。

MAY，SHOULD，MUST，SHOULD NOT，MUST NOT：这些术语（全部大写）的使用如[RFC2119]中所定义。所有关于可选行为的陈述要么使用MAY，SHOULD，或SHOULD NOT。

