[点击这里跳转到陈孝松个人主页:chenxiaosong.com](http://chenxiaosong.com/)。

[点击这里查看陈孝松所有博客](http://chenxiaosong.com/blog)。

# 环境信息

```sh
uname 
Linux localhost.localdomain 4.19.90-24.4.v2101.ky10.x86_64 #1 SMP Mon May 24 12:14:55 CST 2021 x86_64 x86_64 x86_64 GNU/Linux

mount | grep nfs
200.22.252.66:/data0/media on /data0/media type nfs4 (rw,relatime,sync,vers=4.2,rsize=1048576,wsize=1048576,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=200.22.252.67,local_lock=none,addr=200.22.252.66)
```

# 问题描述

client端`df -h`卡住，读写不可用。

client端报错：
```sh
Nov 14 13:21:32 localhost kernel: [2762097.294397] nfs: server 200.22.252.66 not responding, still trying
```

server端报错（暂不确定是否相关）：
```sh
Nov 14 13:02:17 localhost kernel: [2761217.103877] nfsd4_validate_stateid: 26 callbacks suppressed
...
Nov 14 13:02:17 localhost kernel: [2761217.104230] NFSD: client 200.22.252.69 testing state ID with incorrect client ID
```

# 代码分析

社区[stable仓库的linux.4.19.y分支](https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git)执行命令`git log -L:nfsd4_validate_stateid:fs/nfsd/nfs4state.c`可以看到`nfsd4_validate_stateid`函数还经过以下修改：

- [600df3856f0b nfsd: Remove incorrect check in nfsd4_validate_stateid](https://lore.kernel.org/all/20230718123837.124780-1-trondmy@kernel.org/)
- [c6ac11906599 nfsd4: kill warnings on testing stateids with mismatched clientids](https://lore.kernel.org/all/20200319141849.GB1546@fieldses.org/)

server端代码：
```c
nfsd4_test_stateid
  nfsd4_validate_stateid
    pr_warn_ratelimited("NFSD: client %s testing state ID with incorrect client ID\n", addr_str);
      printk_ratelimited
        __ratelimit
          ___ratelimit
            printk_deferred(KERN_WARNING "%s: %d callbacks suppressed\n"
```

client端代码：
```c
PROC41(TEST_STATEID,    enc_test_stateid,       dec_test_stateid),
  NFSPROC4_CLNT_TEST_STATEID


nfs41_test_and_free_expired_stateid
  nfs41_test_stateid
    _nfs41_test_stateid
      .rpc_proc = &nfs4_procedures[NFSPROC4_CLNT_TEST_STATEID]

nfs4_state_manager
  nfs4_do_reclaim
    nfs4_reclaim_open_state
      .recover_open   = nfs41_open_expired,
        nfs41_open_expired
          nfs41_check_open_stateid
            nfs41_test_and_free_expired_stateid

update_open_stateid
  nfs4_test_and_free_stateid
    .test_and_free_expired = nfs41_test_and_free_expired_stateid, // nfs_v4_1_minor_ops
      nfs41_test_and_free_expired_stateid
```

# `600df3856f0b nfsd: Remove incorrect check in nfsd4_validate_stateid`补丁邮件

[600df3856f0b nfsd: Remove incorrect check in nfsd4_validate_stateid](https://lore.kernel.org/all/20230718123837.124780-1-trondmy@kernel.org/)邮件及回复的邮件写了：

- Trond Myklebust: 如果客户端正在调用 TEST_STATEID，那是因为发生了某个事件，需要对所有状态标识进行有效性检查，并在已被撤销的状态标识上调用 FREE_STATEID。在这种情况下，要么该状态标识存在于与该 nfs4_client 关联的状态标识列表中（此时应该进行测试），要么不存在。没有其他需要考虑的条件。
- Jeff Layton: 我不太明白。这是在修复一个实际的 bug 吗？虽然承认这段代码似乎是不必要的，但移除它似乎不会导致用户可见的行为变化。我是否漏掉了什么？
- Trond Myklebust: 在 [https://bugzilla.redhat.com/show_bug.cgi?id=2176575](https://bugzilla.redhat.com/show_bug.cgi?id=2176575) 中明显触发了这个问题。此外，如果您查看提交 [663e36f07666](https://lore.kernel.org/all/20200319141849.GB1546@fieldses.org/)，您会发现它所做的一切就是移除日志消息，因为“这是预期的”。由于某种未知的原因，它没有意识到“然后检查是不正确的”。因此，是的，这是在修复一个真实的 bug。
- Jeff Layton: 是的，就我所知，那个提交只是移除了警告。我的假设是服务器分发的任何 stateid，si_opaque.so_clid 必须与 clid 匹配。但是...看起来 s2s 复制可能改变了这个规则？无论如何，这个补丁看起来没问题，所以我没有异议。我只是试图理解这可能发生的原因。
- Chuck Lever III: 我认为 [663e36f](https://lore.kernel.org/all/20200319141849.GB1546@fieldses.org/) 没有改变这个逻辑：在发出警告时它“返回状态”，在移除警告后它也“返回状态”。如果存在 bug，它是否是在添加了“!same_clid()`”检查时引入的呢？修复：7df302f75ee2 ("NFSD: TEST_STATEID should not return NFS4ERR_STALE_STATEID")
- Trond Myklebust: 正确。它无法修复比该补丁更旧的任何问题，因为它无法应用。
- Chuck Lever III: 正在进行测试。我计划将其应用于 nfsd-fixes 分支（用于 6.5-rc）

引入问题的补丁是[7df302f75ee2 NFSD: TEST_STATEID should not return NFS4ERR_STALE_STATEID](https://lore.kernel.org/all/20120529175556.4472.63375.stgit@lebasque.1015granger.net/)。

邮件中提到[Bug 2176575 点击查看中文翻译](http://chenxiaosong.com/translations/bugzilla-redhat-bug-2176575.html)。